import requests
import json
import re
import time
import telebot
import random
from datetime import datetime

# ================= –ù–ê–°–¢–†–û–ô–ö–ò =================
TELEGRAM_TOKEN = '8250615686:AAEb5LeS8MOZ_8Lykk_8lX_twt7IZ9EqM84'
CHAT_ID = '1099988220'
# --- –°–õ–û–í–ê–†–¨ –ù–ê–ó–í–ê–ù–ò–ô –õ–ê–ë–û–†–ê–¢–û–†–ù–´–• ---
LAB_NAMES = {
    "20488344": "1. –ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –º–æ–ª–µ–∫—É–ª—è—Ä–Ω–æ–π –∞–¥—Å–æ—Ä–±—Ü–∏–∏ —Ä–∞—Å—Ç–≤–æ—Ä–µ–Ω–Ω–æ–≥–æ –≤–µ—â–µ—Å—Ç–≤–∞ –∏–∑ —Ä–∞—Å—Ç–≤–æ—Ä–æ–≤ –Ω–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–Ω–æ–º —É–≥–ª–µ",
    "21516103": "2. –ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –æ–±–º–µ–Ω–Ω–æ–π –∞–¥—Å–æ—Ä–±—Ü–∏–∏ –∏–æ–Ω–æ–≤",
    "20488811": "3. –ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ —Å–≤–æ–π—Å—Ç–≤ –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏ —Ä–∞–∑–¥–µ–ª–∞ —Ñ–∞–∑: —Ä–∞—Å—Ç–≤–æ—Ä –ü–ê–í ‚Äì –≤–æ–∑–¥—É—Ö",
    "21516160": "4. –¢—É—Ä–±–∏–¥–∏–º–µ—Ç—Ä–∏—á–µ—Å–∫–æ–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –∫–æ–ª–ª–æ–∏–¥–Ω—ã—Ö —Å–∏—Å—Ç–µ–º ‚Äî –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ —á–∞—Å—Ç–∏—Ü",
    "21516155": "5. –ò–∑—É—á–µ–Ω–∏–µ –∫–æ–∞–≥—É–ª—è—Ü–∏–∏ –≥–∏–¥—Ä–æ–∑–æ–ª—è –≥–∏–¥—Ä–æ–∫—Å–∏–¥–∞ –∂–µ–ª–µ–∑–∞",
    "20496685": "5. –ò–∑—É—á–µ–Ω–∏–µ –∫–æ–∞–≥—É–ª—è—Ü–∏–∏ –≥–∏–¥—Ä–æ–∑–æ–ª—è –≥–∏–¥—Ä–æ–∫—Å–∏–¥–∞ –∂–µ–ª–µ–∑–∞",
    "21516163": "6. –ü–æ–ª—É—á–µ–Ω–∏–µ –ª–∏–æ—Ñ–æ–±–Ω—ã—Ö –∑–æ–ª–µ–π",
    "21575413": "7. –ó–∞—Ä—è–¥ –≥—Ä–∞–Ω—É–ª—ã"
}

URLS = [
    "https://dikidi.ru/ru/record/596993?p=3.pi-po-ssm-sd&o=7&s=20488344&rl=0_undefined&source=widget",
    "https://dikidi.ru/ru/record/596993?p=3.pi-po-ssm-sd&o=7&s=21516103&rl=0_undefined&source=widget",
    "https://dikidi.ru/ru/record/596993?p=3.pi-po-ssm-sd&o=7&s=20488811&rl=0_undefined&source=widget",
    "https://dikidi.ru/ru/record/596993?p=3.pi-po-ssm-sd&o=7&s=21516160&rl=0_undefined&source=widget",
    "https://dikidi.ru/ru/record/596993?p=3.pi-po-ssm-sd&o=7&s=21516155&rl=0_undefined&source=widget",
    "https://dikidi.ru/ru/record/596993?p=3.pi-po-ssm-sd&o=7&s=20496685&rl=0_undefined&source=widget",
    "https://dikidi.ru/ru/record/596993?p=3.pi-po-ssm-sd&o=7&s=21516163&rl=0_undefined&source=widget",
    "https://dikidi.ru/ru/record/596993?p=3.pi-po-ssm-sd&o=7&s=21575413&rl=0_undefined&source=widget"
]

CHECK_INTERVAL = 300
# =============================================

bot = telebot.TeleBot(TELEGRAM_TOKEN)

HEADERS = {
    'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
    'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8',
    'Accept-Language': 'ru-RU,ru;q=0.9,en-US;q=0.8,en;q=0.7',
    'Referer': 'https://dikidi.ru/'
}

def format_datetime(datetime_str):
    """–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è –≤ —á–∏—Ç–∞–µ–º—ã–π –≤–∏–¥"""
    try:
        dt = datetime.strptime(datetime_str, "%Y-%m-%d %H:%M:%S")
        return dt.strftime("%d.%m.%Y –≤ %H:%M")
    except:
        try:
            dt = datetime.strptime(datetime_str, "%Y-%m-%d")
            return dt.strftime("%d.%m.%Y")
        except:
            return datetime_str

def send_alert(url, service_id, service_name, booking_info):
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram (—Ç–æ–ª—å–∫–æ –≤–∞–∂–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è)"""
    
    if service_name:
        work_info = f"üìö *{service_name}*"
    else:
        work_info = f"üÜî ID: {service_id}"
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ë–ï–ó –º–µ—Å—Ç/–º–∞—Å—Ç–µ—Ä–æ–≤/—Å–ª–æ—Ç–æ–≤
    message = f"üö® *–ï–°–¢–¨ –ú–ï–°–¢–ê!*\n\n{work_info}\n\n"
    
    if booking_info.get('first_datetime'):
        message += f"üìÖ *–ü–µ—Ä–≤–∞—è –∑–∞–ø–∏—Å—å:* `{booking_info['first_datetime']}`\n"
    
    if booking_info.get('available_dates'):
        message += f"üìÜ *–î–Ω–µ–π –¥–æ—Å—Ç—É–ø–Ω–æ:* {booking_info['available_dates']}\n"
    
    # –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É
    message += f"\nüîó [–ó–∞–ø–∏—Å–∞—Ç—å—Å—è —Å–µ–π—á–∞—Å]({url})"
    message += "\n\n‚ö°Ô∏è _–ú–µ—Å—Ç–∞ –±—ã—Å—Ç—Ä–æ —Ä–∞–∑–±–∏—Ä–∞—é—Ç!_"
    
    try:
        bot.send_message(CHAT_ID, message, parse_mode='Markdown')
        print(f"[{datetime.now().strftime('%H:%M:%S')}] ‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!")
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: {e}")

def check_page(url):
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ –º–µ—Å—Ç –∏ —Å–æ–±–∏—Ä–∞–µ—Ç –ø–æ–¥—Ä–æ–±–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: (is_available, booking_info)
    """
    booking_info = {
        'first_datetime': '',
        'available_dates': 0
    }
    
    try:
        response = requests.get(url, headers=HEADERS, timeout=10)
        
        if response.status_code != 200:
            return False, booking_info

        html = response.text
        match = re.search(r'data-options=\'({.*?})\'\s*>', html, re.DOTALL)
        
        if not match:
            return False, booking_info
        
        try:
            options_json = match.group(1).replace('\\"', '"').replace('\\/', '/')
            data = json.loads(options_json)
        except json.JSONDecodeError:
            return False, booking_info
        
        step_data = data.get('step_data', {})
        
        dates_true = step_data.get('dates_true', [])
        times = step_data.get('times', {})
        masters = step_data.get('masters', {})
        first_date_true = step_data.get('first_date_true', '')
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–µ—Ä–≤–æ–µ –¥–æ—Å—Ç—É–ø–Ω–æ–µ –≤—Ä–µ–º—è
        first_datetime = ''
        if times:
            all_times = []
            for time_slots in times.values():
                all_times.extend(time_slots)
            if all_times:
                all_times.sort()
                first_datetime = format_datetime(all_times[0])
        elif first_date_true:
            first_datetime = format_datetime(first_date_true)
        
        # –ó–∞–ø–æ–ª–Ω—è–µ–º booking_info (—Ç–æ–ª—å–∫–æ –¥–∞—Ç–∞ –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π)
        booking_info['first_datetime'] = first_datetime
        booking_info['available_dates'] = len(dates_true)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å
        is_available = len(dates_true) > 0 or len(times) > 0 or len(masters) > 0 or bool(first_date_true)
        
        if is_available:
            print(f"‚úì –ú–ï–°–¢–ê –ï–°–¢–¨ (–¥–∞—Ç—ã:{len(dates_true)})")
        else:
            print(f"‚úó –ú–µ—Å—Ç –Ω–µ—Ç")
        
        return is_available, booking_info
            
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏: {e}")
        return False, booking_info

def get_service_info(url):
    service_id = "Unknown"
    service_name = ""
    if 's=' in url:
        service_id = url.split('s=')[1].split('&')[0]
        service_name = LAB_NAMES.get(service_id, "")
    return service_id, service_name

def main():
    print(f"üîç –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∑–∞–ø—É—â–µ–Ω ({len(URLS)} —Å—Å—ã–ª–æ–∫)")
    print(f"–†–µ–∂–∏–º: –ë–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ü–∏–∫–ª\n")
    
    status_history = {url: False for url in URLS}
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –∑–∞–ø—É—Å–∫–µ
    try:
        bot.send_message(
            CHAT_ID, 
            f"üü¢ *–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∑–∞–ø—É—â–µ–Ω!*\n\n"
            f"üìä –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç—Å—è: {len(URLS)} —Ä–∞–±–æ—Ç\n"
            f"‚è± –ò–Ω—Ç–µ—Ä–≤–∞–ª: {CHECK_INTERVAL} —Å–µ–∫\n"
            f"üïí –í—Ä–µ–º—è –∑–∞–ø—É—Å–∫–∞: {datetime.now().strftime('%d.%m.%Y %H:%M')}",
            parse_mode='Markdown'
        )
    except:
        pass

    while True:
        try:
            for url in URLS:
                service_id, service_name = get_service_info(url)
                
                is_available, booking_info = check_page(url)
                was_available = status_history[url]
                
                # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –º–µ—Å—Ç–æ —Ç–æ–ª—å–∫–æ —á—Ç–æ –ø–æ—è–≤–∏–ª–æ—Å—å
                if is_available and not was_available:
                    send_alert(url, service_id, service_name, booking_info)
                
                status_history[url] = is_available
                
                # –í—ã–≤–æ–¥ –≤ –∫–æ–Ω—Å–æ–ª—å
                if is_available:
                    time_info = booking_info.get('first_datetime', '')
                    print(f"[{datetime.now().strftime('%H:%M:%S')}] ‚úÖ {service_id}: {time_info}")
                else:
                    print(f"[{datetime.now().strftime('%H:%M:%S')}] ‚ùå {service_id}")

            sleep_time = CHECK_INTERVAL + random.randint(2, 5)
            time.sleep(sleep_time)
            
        except KeyboardInterrupt:
            print("\n‚õî –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º.")
            try:
                bot.send_message(CHAT_ID, "üî¥ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω", parse_mode='Markdown')
            except:
                pass
            break
        except Exception as e:
            print(f"\n‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {e}")
            print("–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ 10 —Å–µ–∫—É–Ω–¥...")
            time.sleep(10)

if __name__ == "__main__":
    main()
