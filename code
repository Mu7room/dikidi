import requests
import json
import re
import time
import telebot
import random
from datetime import datetime

# ================= –ù–ê–°–¢–†–û–ô–ö–ò =================
TELEGRAM_TOKEN = '8250615686:AAEb5LeS8MOZ_8Lykk_8lX_twt7IZ9EqM84'
CHAT_ID = '1099988220'

URLS = [
    "https://dikidi.ru/ru/record/596993?p=3.pi-po-ssm-sd&o=7&s=21516155&rl=0_undefined&source=widget",
    "https://dikidi.ru/ru/record/596993?p=3.pi-po-ssm-sd&o=7&s=20496685&rl=0_undefined&source=widget",
    "https://dikidi.ru/ru/record/596993?p=3.pi-po-ssm-sd&o=7&s=21516103&rl=0_undefined&source=widget",
    "https://dikidi.ru/ru/record/596993?p=3.pi-po-ssm-sd&o=7&s=21516143&rl=0_undefined&source=widget",
    "https://dikidi.ru/ru/record/596993?p=3.pi-po-ssm-sd&o=7&s=21516163&rl=0_undefined&source=widget",
    "https://dikidi.ru/ru/record/596993?p=3.pi-po-ssm-sd&o=7&s=21575413&rl=0_undefined&source=widget",
    "https://dikidi.ru/ru/record/596993?p=3.pi-po-ssm-sd&o=7&s=20488314&rl=0_undefined&source=widget"
]

# –ò–Ω—Ç–µ—Ä–≤–∞–ª –ø—Ä–æ–≤–µ—Ä–∫–∏ (—Å–µ–∫—É–Ω–¥—ã). –ù–µ —Å—Ç–∞–≤—å—Ç–µ –º–µ–Ω—å—à–µ 30!
CHECK_INTERVAL = 300

# =============================================

bot = telebot.TeleBot(TELEGRAM_TOKEN)

HEADERS = {
    'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
    'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8',
    'Accept-Language': 'ru-RU,ru;q=0.9,en-US;q=0.8,en;q=0.7',
    'Referer': 'https://dikidi.ru/'
}

def send_alert(url, service_id=""):
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram"""
    message = (
        "üö® –ï–°–¢–¨ –ú–ï–°–¢–ê!\n\n"
        f"–£—Å–ª—É–≥–∞ ID: {service_id}\n"
        f"–°—Å—ã–ª–∫–∞: {url}\n\n"
        "–£—Å–ø–µ–π—Ç–µ –∑–∞–ø–∏—Å–∞—Ç—å—Å—è!"
    )
    try:
        # –ë–µ–∑ parse_mode, —á—Ç–æ–±—ã —Å—Å—ã–ª–∫–∞ –Ω–µ –ª–æ–º–∞–ª–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
        bot.send_message(CHAT_ID, message)
        print(f"[{datetime.now().strftime('%H:%M:%S')}] ‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!")
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: {e}")

def check_page(url):
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ –º–µ—Å—Ç —á–µ—Ä–µ–∑ –∞–Ω–∞–ª–∏–∑ data-options JSON.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç True, –µ—Å–ª–∏ –º–µ—Å—Ç–∞ –ï–°–¢–¨.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç False, –µ—Å–ª–∏ –º–µ—Å—Ç –ù–ï–¢.
    """
    try:
        response = requests.get(url, headers=HEADERS, timeout=10)
        
        if response.status_code != 200:
            print(f"–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ ({response.status_code})")
            return False

        html = response.text
        
        # –ò—â–µ–º data-options JSON –≤ div.newrecord2
        # –ü—Ä–∏–º–µ—Ä: <div class="newrecord2 height100" data-options='{"lang":"ru",...}'>
        match = re.search(r'data-options=\'({.*?})\'\s*>', html, re.DOTALL)
        
        if not match:
            print("–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ data-options")
            return False
        
        try:
            options_json = match.group(1)
            # –ò—Å–ø—Ä–∞–≤–ª—è–µ–º —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–∞–≤—ã—á–∫–∏ –¥–ª—è JSON
            options_json = options_json.replace('\\"', '"').replace('\\/', '/')
            data = json.loads(options_json)
        except json.JSONDecodeError as e:
            print(f"–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON: {e}")
            return False
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–ª—é—á–µ–≤—ã–µ –ø–æ–ª—è –≤ step_data
        step_data = data.get('step_data', {})
        
        # –ï—Å–ª–∏ –µ—Å—Ç—å –¥–∞—Ç—ã –∏ –≤—Ä–µ–º—è - –º–µ—Å—Ç–∞ –µ—Å—Ç—å
        dates_true = step_data.get('dates_true', [])
        times = step_data.get('times', [])
        masters = step_data.get('masters', [])
        first_date_true = step_data.get('first_date_true', '')
        
        # –õ–æ–≥–∏–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏:
        # –ï—Å–ª–∏ –º–∞—Å—Å–∏–≤—ã –ø—É—Å—Ç—ã–µ –∏ first_date_true –ø—É—Å—Ç–æ–π - –º–µ—Å—Ç –Ω–µ—Ç
        has_dates = len(dates_true) > 0
        has_times = len(times) > 0
        has_masters = len(masters) > 0
        has_first_date = bool(first_date_true)
        
        # –ï—Å–ª–∏ –µ—Å—Ç—å —Ö–æ—Ç—å –æ–¥–∏–Ω –ø—Ä–∏–∑–Ω–∞–∫ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ - –º–µ—Å—Ç–∞ –µ—Å—Ç—å
        is_available = has_dates or has_times or has_masters or has_first_date
        
        if is_available:
            print(f"‚úì –ú–ï–°–¢–ê –ï–°–¢–¨ (dates:{len(dates_true)}, times:{len(times)}, masters:{len(masters)})")
        else:
            print(f"‚úó –ú–µ—Å—Ç –Ω–µ—Ç (dates:{len(dates_true)}, times:{len(times)}, masters:{len(masters)})")
        
        return is_available
            
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ: {e}")
        return False

def main():
    print(f"üîç –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∑–∞–ø—É—â–µ–Ω ({len(URLS)} —Å—Å—ã–ª–æ–∫)")
    print(f"–¶–µ–ª—å: –ü—Ä–æ–≤–µ—Ä–∫–∞ data-options –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å–ª–æ—Ç–æ–≤")
    print(f"–ò–Ω—Ç–µ—Ä–≤–∞–ª: {CHECK_INTERVAL} —Å–µ–∫\n")
    
    alerted_urls = set()

    while True:
        for url in URLS:
            if url in alerted_urls:
                continue

            is_available = check_page(url)
            
            if is_available:
                # –ò–∑–≤–ª–µ–∫–∞–µ–º ID —É—Å–ª—É–≥–∏ –∏–∑ URL –¥–ª—è –æ—Ç—á–µ—Ç–∞
                service_id = "Unknown"
                if 's=' in url:
                    service_id = url.split('s=')[1].split('&')[0]
                
                send_alert(url, service_id)
                alerted_urls.add(url)
                print(">>> –ú–ï–°–¢–û –ù–ê–ô–î–ï–ù–û! –û–∂–∏–¥–∞–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...\n")
            else:
                service_id = url.split('s=')[1].split('&')[0] if 's=' in url else '??'
                print(f"[{datetime.now().strftime('%H:%M:%S')}] –ù–µ—Ç –º–µ—Å—Ç: ID={service_id}")

        # –ï—Å–ª–∏ –≤—Å–µ —Å—Å—ã–ª–∫–∏ –æ—Ç—Ä–∞–±–æ—Ç–∞–Ω—ã
        if len(alerted_urls) == len(URLS):
            print("\n‚úÖ –í—Å–µ —Å—Å—ã–ª–∫–∏ –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã, —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã.")
            print("–°–∫—Ä–∏–ø—Ç –∑–∞–≤–µ—Ä—à–∞–µ—Ç —Ä–∞–±–æ—Ç—É.")
            break
            
        # –°–ª—É—á–∞–π–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
        sleep_time = CHECK_INTERVAL + random.randint(2, 5)
        print(f"\n--- –°–ª–µ–¥—É—é—â–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ {sleep_time} —Å–µ–∫ ---\n")
        time.sleep(sleep_time)

if __name__ == "__main__":
    try:
        main()
    except KeyboardInterrupt:
        print("\n‚õî –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º.")
    except Exception as e:
        print(f"\n‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {e}")
