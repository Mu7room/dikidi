import requests
import json
import re
import time
import telebot
import random
from datetime import datetime

# ================= –ù–ê–°–¢–†–û–ô–ö–ò =================
TELEGRAM_TOKEN = '8250615686:AAEb5LeS8MOZ_8Lykk_8lX_twt7IZ9EqM84'
CHAT_ID = '1099988220'

# --- –°–õ–û–í–ê–†–¨ –ù–ê–ó–í–ê–ù–ò–ô –õ–ê–ë–û–†–ê–¢–û–†–ù–´–• ---
LAB_NAMES = {
    "20488344": "–ú–æ–ª–µ–∫ –∞–¥—Å–æ—Ä–±—Ü–∏—è –Ω–∞ —É–≥–ª–µ",
    "21516103": "–û–±–º–µ–Ω–Ω–∞—è –∞–¥—Å–æ—Ä–±—Ü–∏—è",
    "20488811": "–ü–ê–í",
    "21516160": "–¢—É—Ä–±–æ–¥–∏–º–µ—Ç—Ä–∏—á–µ—Å–∫–∏–π –º–µ—Ç–æ–¥",
    "21516155": "–ö–æ–∞–≥ 1",
    "20496685": "–ö–æ–∞–≥ 2",
    "21516163": "–∑–æ–ª–∏",
    "21575413": "–≥—Ä–∞–Ω—É–ª—ã"
}

URLS = [
    "https://dikidi.ru/ru/record/596993?p=3.pi-po-ssm-sd&o=7&s=20488344&rl=0_undefined&source=widget",
    "https://dikidi.ru/ru/record/596993?p=3.pi-po-ssm-sd&o=7&s=21516103&rl=0_undefined&source=widget",
    "https://dikidi.ru/ru/record/596993?p=3.pi-po-ssm-sd&o=7&s=20488811&rl=0_undefined&source=widget",
    "https://dikidi.ru/ru/record/596993?p=3.pi-po-ssm-sd&o=7&s=21516160&rl=0_undefined&source=widget",
    "https://dikidi.ru/ru/record/596993?p=3.pi-po-ssm-sd&o=7&s=21516155&rl=0_undefined&source=widget",
    "https://dikidi.ru/ru/record/596993?p=3.pi-po-ssm-sd&o=7&s=20496685&rl=0_undefined&source=widget",
    "https://dikidi.ru/ru/record/596993?p=3.pi-po-ssm-sd&o=7&s=21516163&rl=0_undefined&source=widget",
    "https://dikidi.ru/ru/record/596993?p=3.pi-po-ssm-sd&o=7&s=21575413&rl=0_undefined&source=widget"

]

# –ò–Ω—Ç–µ—Ä–≤–∞–ª –ø—Ä–æ–≤–µ—Ä–∫–∏ (—Å–µ–∫—É–Ω–¥—ã)
CHECK_INTERVAL = 45

# =============================================

bot = telebot.TeleBot(TELEGRAM_TOKEN)

HEADERS = {
    'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
    'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8',
    'Accept-Language': 'ru-RU,ru;q=0.9,en-US;q=0.8,en;q=0.7',
    'Referer': 'https://dikidi.ru/'
}

def send_alert(url, service_id, service_name=""):
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram"""
    if service_name:
        work_info = f"üìö –†–∞–±–æ—Ç–∞: {service_name}"
    else:
        work_info = f"üÜî ID —É—Å–ª—É–≥–∏: {service_id}"
    
    message = (
        "üö® –ï–°–¢–¨ –ú–ï–°–¢–ê!\n\n"
        f"{work_info}\n"
        f"üîó –°—Å—ã–ª–∫–∞: {url}\n\n"
        "‚ö°Ô∏è –£—Å–ø–µ–π—Ç–µ –∑–∞–ø–∏—Å–∞—Ç—å—Å—è!"
    )
    try:
        bot.send_message(CHAT_ID, message)
        print(f"[{datetime.now().strftime('%H:%M:%S')}] ‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!")
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: {e}")

def check_page(url):
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç True, –µ—Å–ª–∏ –º–µ—Å—Ç–∞ –ï–°–¢–¨.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç False, –µ—Å–ª–∏ –º–µ—Å—Ç –ù–ï–¢.
    """
    try:
        response = requests.get(url, headers=HEADERS, timeout=10)
        
        if response.status_code != 200:
            return False

        html = response.text
        match = re.search(r'data-options=\'({.*?})\'\s*>', html, re.DOTALL)
        
        if not match:
            return False
        
        try:
            options_json = match.group(1).replace('\\"', '"').replace('\\/', '/')
            data = json.loads(options_json)
        except json.JSONDecodeError:
            return False
        
        step_data = data.get('step_data', {})
        
        dates_true = step_data.get('dates_true', [])
        times = step_data.get('times', [])
        masters = step_data.get('masters', [])
        first_date_true = step_data.get('first_date_true', '')
        
        is_available = len(dates_true) > 0 or len(times) > 0 or len(masters) > 0 or bool(first_date_true)
        
        return is_available
            
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏: {e}")
        return False

def get_service_info(url):
    service_id = "Unknown"
    service_name = ""
    if 's=' in url:
        service_id = url.split('s=')[1].split('&')[0]
        service_name = LAB_NAMES.get(service_id, "")
    return service_id, service_name

def main():
    print(f"üîç –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∑–∞–ø—É—â–µ–Ω ({len(URLS)} —Å—Å—ã–ª–æ–∫)")
    print(f"–†–µ–∂–∏–º: –ë–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ü–∏–∫–ª\n")
    
    # –•—Ä–∞–Ω–∏—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ: URL -> –±—ã–ª–æ –ª–∏ –º–µ—Å—Ç–æ –≤ –ø—Ä–æ—à–ª—ã–π —Ä–∞–∑ (True/False)
    status_history = {url: False for url in URLS}

    while True:
        try:
            for url in URLS:
                is_available = check_page(url)
                was_available = status_history[url]
                
                # –õ–æ–≥–∏–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:
                # 1. –ú–µ—Å—Ç–æ –µ—Å—Ç—å –°–ï–ô–ß–ê–° (is_available = True)
                # 2. –ò –º–µ—Å—Ç–∞ –ù–ï –ë–´–õ–û –≤ –ø—Ä–æ—à–ª—ã–π —Ä–∞–∑ (was_available = False)
                # –≠—Ç–æ –∑–Ω–∞—á–∏—Ç, —á—Ç–æ –º–µ—Å—Ç–æ —Ç–æ–ª—å–∫–æ —á—Ç–æ –æ—Å–≤–æ–±–æ–¥–∏–ª–æ—Å—å!
                if is_available and not was_available:
                    service_id, service_name = get_service_info(url)
                    send_alert(url, service_id, service_name)
                
                # –û–±–Ω–æ–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é —Å–æ—Å—Ç–æ—è–Ω–∏—è
                status_history[url] = is_available
                
                # –í—ã–≤–æ–¥ –≤ –∫–æ–Ω—Å–æ–ª—å –¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è, —á—Ç–æ —Å–∫—Ä–∏–ø—Ç –∂–∏–≤
                if is_available:
                    print(f"[{datetime.now().strftime('%H:%M:%S')}] ‚úÖ –ú–ï–°–¢–ê –ï–°–¢–¨: {service_id}")
                else:
                    print(f"[{datetime.now().strftime('%H:%M:%S')}] ‚ùå –ù–µ—Ç –º–µ—Å—Ç: {service_id}")

            # –ó–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–∏–º –∫—Ä—É–≥–æ–º –ø—Ä–æ–≤–µ—Ä–∫–∏
            sleep_time = CHECK_INTERVAL + random.randint(2, 5)
            time.sleep(sleep_time)
            
        except KeyboardInterrupt:
            print("\n‚õî –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º.")
            break
        except Exception as e:
            print(f"\n‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {e}")
            print("–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ 10 —Å–µ–∫—É–Ω–¥...")
            time.sleep(10)

if __name__ == "__main__":
    main()
