import requests
from bs4 import BeautifulSoup
import time
import telebot
import random
from datetime import datetime

# ================= –ù–ê–°–¢–†–û–ô–ö–ò =================
TELEGRAM_TOKEN = '8250615686:AAEb5LeS8MOZ_8Lykk_8lX_twt7IZ9EqM84'
CHAT_ID = '1099988220'

URLS = [
    "https://dikidi.ru/ru/record/596993?p=3.pi-po-ssm-sd&o=7&s=21516155&rl=0_undefined&source=widget",
    "https://dikidi.ru/ru/record/596993?p=3.pi-po-ssm-sd&o=7&s=20496685&rl=0_undefined&source=widget",
    "https://dikidi.ru/ru/record/596993?p=3.pi-po-ssm-sd&o=7&s=21516103&rl=0_undefined&source=widget",
    "https://dikidi.ru/ru/record/596993?p=3.pi-po-ssm-sd&o=7&s=21516143&rl=0_undefined&source=widget",
    "https://dikidi.ru/ru/record/596993?p=3.pi-po-ssm-sd&o=7&s=21516163&rl=0_undefined&source=widget",
    "https://dikidi.ru/ru/record/596993?p=3.pi-po-ssm-sd&o=7&s=21575413&rl=0_undefined&source=widget"
]

# –ò–Ω—Ç–µ—Ä–≤–∞–ª –ø—Ä–æ–≤–µ—Ä–∫–∏ (—Å–µ–∫—É–Ω–¥—ã). 
# DikiDi –º–æ–∂–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∑–∞ —á–∞—Å—Ç—ã–µ –∑–∞–ø—Ä–æ—Å—ã. –ú–∏–Ω–∏–º—É–º 30-40 —Å–µ–∫.
CHECK_INTERVAL = 45 

# =============================================

bot = telebot.TeleBot(TELEGRAM_TOKEN)

HEADERS = {
    'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
    'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8',
    'Accept-Language': 'ru-RU,ru;q=0.9,en-US;q=0.8,en;q=0.7',
    'Referer': 'https://dikidi.ru/'
}

def send_alert(url, service_id=""):
    message = (
        "üö® *–ï–°–¢–¨ –ú–ï–°–¢–ê!*\n\n"
        f"üÜî –£—Å–ª—É–≥–∞: {service_id}\n"
        f"üîó –°—Å—ã–ª–∫–∞: {url}\n\n"
        "‚ö°Ô∏è –£—Å–ø–µ–π—Ç–µ –∑–∞–ø–∏—Å–∞—Ç—å—Å—è!"
    )
    try:
        bot.send_message(CHAT_ID, message, parse_mode='Markdown')
        print(f"[{datetime.now().strftime('%H:%M:%S')}] ‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!")
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: {e}")

def check_page(url):
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç True, –µ—Å–ª–∏ –º–µ—Å—Ç –ù–ï–¢ (–µ—Å—Ç—å –æ—à–∏–±–∫–∞).
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç False, –µ—Å–ª–∏ –º–µ—Å—Ç–∞ –ï–°–¢–¨ (–æ—à–∏–±–∫–∏ –Ω–µ—Ç).
    """
    try:
        response = requests.get(url, headers=HEADERS, timeout=10)
        
        if response.status_code != 200:
            print(f"–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ ({response.status_code})")
            return True # –°—á–∏—Ç–∞–µ–º —á—Ç–æ –º–µ—Å—Ç –Ω–µ—Ç, —á—Ç–æ–±—ã –Ω–µ —Å–ø–∞–º–∏—Ç—å –æ—à–∏–±–∫–æ–π

        soup = BeautifulSoup(response.text, 'html.parser')
        
        # --- –õ–û–ì–ò–ö–ê –ü–†–û–í–ï–†–ö–ò ---
        
        # 1. –ò—â–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –æ—à–∏–±–∫–∏. 
        # –ö–Ω–æ–ø–∫–∞ "–ü–æ–∑–≤–æ–Ω–∏—Ç—å" –ª–µ–∂–∏—Ç –≤–Ω—É—Ç—Ä–∏ <div class="nr-error">.
        # –≠—Ç–æ—Ç –±–ª–æ–∫ –ø–æ—è–≤–ª—è–µ—Ç—Å—è –≤ DOM —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –º–µ—Å—Ç –Ω–µ—Ç.
        error_block = soup.find('div', class_='nr-error')
        
        # 2. –ò—â–µ–º –∫–Ω–æ–ø–∫—É "–ü–æ–∑–≤–æ–Ω–∏—Ç—å" –≤–Ω—É—Ç—Ä–∏ –æ—à–∏–±–∫–∏ –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏
        call_button = None
        if error_block:
            call_button = error_block.find('a', class_='nr-error-call')
        
        # 3. –ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–µ –º–∞—Ä–∫–µ—Ä—ã (–∏—â–µ–º –ø—Ä–∏–∑–Ω–∞–∫–∏ —Ç–æ–≥–æ, —á—Ç–æ –∑–∞–ø–∏—Å—å –†–ê–ë–û–¢–ê–ï–¢)
        # –ö–Ω–æ–ø–∫–∏ –≤—Ä–µ–º–µ–Ω–∏ –∏–ª–∏ –∫–Ω–æ–ø–∫–∞ "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å"
        time_slots = soup.find('button', class_='nr-time')
        continue_btn = soup.find('a', class_='nr-continue')
        
        # --- –ü–†–ò–ù–Ø–¢–ò–ï –†–ï–®–ï–ù–ò–Ø ---
        
        # –ï—Å–ª–∏ –µ—Å—Ç—å –±–ª–æ–∫ –æ—à–∏–±–∫–∏ –ò –∫–Ω–æ–ø–∫–∞ –∑–≤–æ–Ω–∫–∞ –≤–Ω—É—Ç—Ä–∏ -> –ú–ï–°–¢ –ù–ï–¢
        if error_block and call_button:
            return True # –ú–µ—Å—Ç –Ω–µ—Ç
        
        # –ï—Å–ª–∏ –µ—Å—Ç—å —Å–ª–æ—Ç—ã –≤—Ä–µ–º–µ–Ω–∏ –ò–õ–ò –∫–Ω–æ–ø–∫–∞ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è -> –ú–ï–°–¢–ê –ï–°–¢–¨
        if time_slots or continue_btn:
            return False # –ú–µ—Å—Ç–∞ –µ—Å—Ç—å!
            
        # –ï—Å–ª–∏ –º—ã –Ω–µ –Ω–∞—à–ª–∏ –Ω–∏ –æ—à–∏–±–∫–∏, –Ω–∏ –∫–Ω–æ–ø–æ–∫ –∑–∞–ø–∏—Å–∏ -> –°–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ –º–µ—Å—Ç–∞ –µ—Å—Ç—å
        # (—Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∑–∏–ª–∞—Å—å, –Ω–æ JS –µ—â–µ –Ω–µ –æ—Ç—Ä–∏—Å–æ–≤–∞–ª —Å–ª–æ—Ç—ã, –∏–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å)
        # –ù–æ –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏ –ø—Ä–æ–≤–µ—Ä–∏–º —Ç–µ–∫—Å—Ç –æ—à–∏–±–∫–∏
        page_text = soup.get_text()
        if "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏" in page_text or "–ù–µ—Ç –Ω–∏ –æ–¥–Ω–æ–≥–æ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞" in page_text:
            return True # –ú–µ—Å—Ç –Ω–µ—Ç (—Ç–µ–∫—Å—Ç–æ–≤–∞—è –æ—à–∏–±–∫–∞)
            
        # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å—á–∏—Ç–∞–µ–º —á—Ç–æ –º–µ—Å—Ç–∞ –µ—Å—Ç—å (–ª—É—á—à–µ –ª–æ–∂–Ω–∞—è —Ç—Ä–µ–≤–æ–≥–∞, —á–µ–º –ø—Ä–æ–ø—É—Å–∫)
        return False 
            
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ: {e}")
        return True # –ü—Ä–∏ –æ—à–∏–±–∫–µ —Å–µ—Ç–∏ —Å—á–∏—Ç–∞–µ–º —á—Ç–æ –º–µ—Å—Ç –Ω–µ—Ç

def main():
    print(f"üîç –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∑–∞–ø—É—â–µ–Ω ({len(URLS)} —Å—Å—ã–ª–æ–∫).")
    print(f"–¶–µ–ª—å: –ò—Å—á–µ–∑–Ω–æ–≤–µ–Ω–∏–µ –±–ª–æ–∫–∞ –æ—à–∏–±–∫–∏ nr-error")
    
    alerted_urls = set()

    while True:
        for url in URLS:
            if url in alerted_urls:
                continue

            # True = –º–µ—Å—Ç –Ω–µ—Ç, False = –º–µ—Å—Ç–∞ –µ—Å—Ç—å
            is_unavailable = check_page(url)
            
            if not is_unavailable:
                # –ú–ï–°–¢–ê –ï–°–¢–¨!
                service_id = url.split('s=')[1].split('&')[0] if 's=' in url else 'Unknown'
                send_alert(url, service_id)
                alerted_urls.add(url)
                print(">>> –ú–ï–°–¢–û –ù–ê–ô–î–ï–ù–û! –û–∂–∏–¥–∞–Ω–∏–µ...")
            else:
                # –ú–µ—Å—Ç –Ω–µ—Ç
                print(f"[{datetime.now().strftime('%H:%M:%S')}] –ù–µ—Ç –º–µ—Å—Ç: ...s={url.split('s=')[1][:8] if 's=' in url else '??'}")

        if len(alerted_urls) == len(URLS):
            print("‚úÖ –í—Å–µ —Å—Å—ã–ª–∫–∏ –æ—Ç—Ä–∞–±–æ—Ç–∞–Ω—ã.")
            break
            
        time.sleep(CHECK_INTERVAL + random.randint(2, 5))

if __name__ == "__main__":
    try:
        main()
    except KeyboardInterrupt:
        print("\n‚õî –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ.")
